---
title: "Lassen FIA Processing - Hardwoods removed from dataset"
author: "Alexis Bernal"
date: "February 28, 2020"
output: word_document
---

#Loading libraries necessary to process FIA data

```{r}
library(raster) #Work with raster files
library(rgdal) #Work with spatial files
library(sf) #Work with spatial files
library(here) #Call on files from Collins_Pine-master R project
library(tidyverse) #Data wrangling and manipulation
```

#Section I

Creating a reproducible process of importing spatial data into R and selecting plots from FIA data to compare to Historical QQ data from Collins Pine. When looking for the appropriate "boundary" to constrain our sampling of FIA data, our choices were limited to Lassen/Plumas National Forest and multiple county boundaries (QQ plots located in Tehama and Plumas County... also added Lassen). Although we could look at NF or county boundaries separateley, I chose to inculde both to see if we could get a robust sample size for both public and private land for comparisons.  Parts of this section are pretty time-consuming processes (section distinguished) because the DEMs are such a huge dataset, so I exported the final clipped DEM to call on for future uses.

```{r}
#Looking at the spreadsheet, whole CN number is not visible.
#Setting up options in R to view all digits (max is 22).
options(digits = 22)

#Loading FIA plot data (USFS FIA)
FIA <- read.csv(here("large_files/CA_FIA", "CA_PLOTSNAP.csv"))

#Filtering FIA for inventory year (INVYR) > 2011 (measure in 10-yr cycles).
#Plots within these years have the same plot design protocol (DESIGNCD = 1).
#Plots within these years are also the most current (some plots are remeasured).
#Creating new ID's based on coordinates to identify remeasured plots.
#PREV_PLT_CN does indicate that some of these plots are re-measurements, but...
#Previous measurements taken before 2011 (so not "double counting" plots in this dataset).
#Filtered for most recent data (max INVYR), just in case there are duplicates.
#Technically 4-subplots/plot - so looks like duplicate entries for each year, but they're not.
#Removing duplicate rows for now (just need to subset plot locations).
#Extracting relevant columns for analysis.
#Adding coordinate columns to retain in sf dataframe.
#Converting FIA data to simple feature.
FIA.sf <- FIA %>%
  filter(INVYR > 2010) %>%
  mutate(new.ID = group_indices(., LON, LAT)) %>%
  group_by(new.ID) %>%
  filter(INVYR == max(INVYR)) %>%
  ungroup() %>%
  mutate(duplicates = duplicated(new.ID)) %>%
  filter(duplicates == "FALSE") %>%
  dplyr::select(CN, PREV_PLT_CN, INVYR, PLOT, LON, LAT, ELEV, DESIGNCD) %>%
  mutate(x.coord = LON,
         y.coord = LAT) %>%
  st_as_sf(., coords = c("LON", "LAT"))

#Loading shapefile of Administrative USFS National Forest Boundaries (USFS GIS website).
#https://data.fs.usda.gov/geodata/edw/datasets.php?dsetCategory=boundaries
#Subsetting boundaries of Lassen NF and Plumas NF.
#EPSG 4269, NAD83.
#Renaming column FORESTNAME and subsetting geometry to join with other boundaries.
forest.sf <- st_read(here("large_files/USFS_boundaries", "S_USA.AdministrativeForest.shp")) %>%
  filter(FORESTNAME == "Lassen National Forest" |
           FORESTNAME == "Plumas National Forest") %>%
  rename(NAME = FORESTNAME) %>%
  dplyr::select(NAME,
                geometry)

#Loading shapefile of California county boundaries (ESRI).
#https://www.arcgis.com/home/item.html?id=2f227372477d4cddadc0cd0b002ec657
#Subsetting boundaries of Tehama, Plumas, and Lassen counties.
#EPSG 4326, WGS84... will have to transform
county.sf <- st_read(here("large_files/CA_counties", "CA_counties.shp")) %>%
  filter(NAMELSAD == "Tehama County" |
           NAMELSAD == "Plumas County" |
           NAMELSAD == "Lassen County") %>%
  dplyr::select(NAME, 
                geometry)

#Setting CRS of FIA plot data to same CRS of NF boundaries (EPSG 4269).
#Transforming CRS of county shapefiles to same CRS of NF boundaries.
FIA.sf <- st_set_crs(FIA.sf, st_crs(forest.sf))
county.sf <- st_transform(county.sf, st_crs(forest.sf))

#combining polygons into one dataframe.
boundary.sf <- rbind(forest.sf, county.sf)

#Loading DEMs that fit within Lassen/Plumas National Forest (USGS National Map).
#Kept the original file names from USGS National Map, 
#just in case the DEMs need to be downloaded.
DEM.1 <- raster(here("large_files/USGS_NED_13_n40w122_IMG",
                     "USGS_NED_13_n40w122_IMG.img"))
DEM.2 <- raster(here("large_files/USGS_NED_13_n41w121_IMG",
                      "USGS_NED_13_n41w121_IMG.img"))
DEM.3 <- raster(here("large_files/USGS_NED_13_n41w122_IMG",
                     "USGS_NED_13_n41w122_IMG.img"))
DEM.4 <- raster(here("large_files/USGS_NED_13_n42w122_IMG",
                     "USGS_NED_13_n42w122_IMG.img"))
DEM.5 <- raster(here("large_files/USGS_NED_13_n40w121_IMG",
                     "USGS_NED_13_n40w121_IMG.img"))
DEM.6 <- raster(here("large_files/USGS_NED_13_n40w123_IMG",
                     "USGS_NED_13_n40w123_IMG.img"))
DEM.7 <- raster(here("large_files/USGS_NED_13_n41w123_IMG",
                     "USGS_NED_13_n41w123_IMG.img"))
DEM.8 <- raster(here("large_files/USGS_NED_13_n42w121_IMG",
                     "USGS_NED_13_n42w121_IMG.img"))

######################################################################################
#ONLY DO THE FOLLOWING SECTION OF CODE ONCE - TIME CONSUMING!
######################################################################################
#Mosaic rasters and recalculate mean pixel value for overlapping pixels.
#DEM raster projected in NAD83.
DEM.mosaic <- mosaic(DEM.1, DEM.2, DEM.3, DEM.4, 
                     DEM.5, DEM.6, DEM.7, DEM.8,
                     fun = mean)

#Exporting mosaic file.
writeRaster(DEM.mosaic, here("GIS/FILES_from_R", "DEM_mosaic"), 
            format = "HFA", 
            overwrite = TRUE)

#Clipping DEM to NF boundary.
#Masking DEM to NF boundary.
DEM.clip <- crop(DEM.mosaic, extent(boundary.sf))
DEM.mask <- mask(DEM.clip, boundary.sf)

#Exporting file - Saved raster as a .img ("HFA").
writeRaster(DEM.mask, here("GIS/Files_from_R", "DEM_mask"), 
            format = "HFA", 
            overwrite = TRUE)

######################################################################################
#END OF CODE - CONTINUE WITH ANALYSIS
######################################################################################

#Clipping FIA plot data to NF boundary.
#Removed duplicates (resulted from overlapping boundaries).
FIA.sf.clip <- st_intersection(FIA.sf, boundary.sf) %>%
  mutate(duplicates = duplicated(CN)) %>%
  filter(duplicates == "FALSE")

#Loading clipped DEM data.
DEM <- raster(here("GIS/Files_from_R", "DEM_mask.img"))

#Checking alignments of layers.
#For FIA plots.
#For DEM.
#Looks good.
plot(DEM)
plot(boundary.sf["geometry"], col = NA, border = "black", add = TRUE)
plot(FIA.sf.clip["geometry"], col = "red", add = TRUE)

#Start with 985 plots (FIA plots within boundary).
#Extracting DEM values to FIA plots.
#Converting elevation of FIA plots (originally in feet) to meters.
#Selecting FIA plots within the elevation range of the QQ data (1113m - 2126m; removed 254 plots).
#Selecting plots within "fuzzing" standards (150 m max discrepancy; removed 25 plots).
#End with 706 plots.
elevation <- FIA.sf.clip %>%
  mutate(DEM.value = raster::extract(DEM,.),
         ELEV_met= as.double(ELEV/3.281),
         Elev.discrepancy = abs(ELEV_met - DEM.value)) %>%
  filter(ELEV_met > 1112 &
           ELEV_met < 2127) %>%
  filter(Elev.discrepancy < 151)
```

#Section II - Extracting plot data for plots with only 1 condition

First, created functions to estimate density (TPHA) and live BA (sq m/ha). Checking what the sample size would be given several constraints: only 1 condition (no split conditions within the plot), live BA > 9 m^2/ha, no fire damage, and no anomalous forest type. Our sample size started with 706 plots, after accounting for elevation discrepancies from fuzzing and being within the elevation range of the historical data. Found 188 plots had more than one condition and an additional 285 plots had fire associated with them (disturbance codes 30-32). Also found an additional 16 plots with non-stocked (FORTYPCD = 999, and FORTYPCD = NA) codes. After reading FIA user guide, seems like plots have NA values because they may have been incorrectly tallied in a previous measurement. The designated forest types seem like a reasonable comparison for the historical QQ data, with the exception of Big Maple (n =1) and Mountain Hemlock (n = 1). After aggregating tree data, found that 52 plots had live BA < 9 m^2. Checked stocking codes and found all plots had codes 4-5 (poor and non-stocked). After estimating live BA by species, also removed 1 plot becuase live conifer BA was < 9 m^2. Since we also want to look at Fir-Pine ratio, I removed an additional 4 plots that did not any Abies or Pinus spp. present. After accounting for these constraints, our sample size would be 159 plots - 119 federally/state-owned and 40 privately/native-owned. Proceeded with aggregating tree data for each plot and exported a .csv file.

```{r}
#Create function to estimate density (trees/ha),
#Where x = TPA_UNADJ (TPA of a given tree),
#and 0.4047 is the conversion (ac to ha).
density.FUN <- function(x)
{density <- sum(x)/0.4047}

#Create function to estimate live BA (sq m/ha),
#Where a = DBH (in) of a given tree, b = TPA_UNADJ (TPA of that tree),
#0.00694444 is the conversion from sq in to sq ft,
#and 0.229568 is the conversion (sq ft/ac to sq m/ha).
liveba.FUN <- function(a,b)
{liveba <-  (sum(((pi*(a/2)^2)*0.00694444)*b))*0.229568}

#Import FIA condition and tree list data.
#Import forest and species reference lists from FIA.
FIA_TREE <- read.csv(here("large_files/CA_FIA", "CA_TREE.csv"))
FIA_COND <- read.csv(here("large_files/CA_FIA", "CA_COND.csv"))
FIA_COND <- FIA_COND[,-which(sapply(FIA_COND, function(x)all(is.na(x))))] #Delete empty columns
FIA_TREE <- FIA_TREE[,-which(sapply(FIA_TREE, function(x)all(is.na(x))))] #Delete empty columns
fia_forest_types <- read.csv(here("large_files/CA_FIA", "REF_FOREST_TYPE.csv"))
fia_species_list <- read.csv(here("large_files/CA_FIA", "REF_SPECIES.csv"))

#Renaming CN column to PLT_CN to join COND and TREE tables.
#According to FIA user guide,
#CN of plot data = PLT_CN of COND/TREE data (foreign key)
elevation <- elevation %>%
 rename(PLT_CN = CN)

#Joining COND table with subset of FIA data (PLT_CN is the foreign key).
#Extracting columns describing "conditions" (e.g. condition code, stand age, disturbance, stocking).
#Calculate number of conditions for each plot.
#Start with 706 plots.
#Remove plots with more than 1 condition (188 plots removed; 518 plots remain).
#Remove plots with fire damage (285 plots removed; 233 plots remain).
#Removed plots where FORTYPCD = 999 and NA (non-stocked - 16 plots removed, 217 plots remain).
#End with 217 plots.
condition_join <- inner_join(FIA_COND, elevation, by = c("PLT_CN", "INVYR")) %>%
  dplyr::select(PLT_CN,
                INVYR,
                ELEV_met,
                COND_STATUS_CD,
                STDAGE,
                FORTYPCD,
                OWNGRPCD,
                DSTRBCD1,
                CONDPROP_UNADJ,
                GSSTKCD,
                BALIVE,
                x.coord,
                y.coord) %>%
  group_by(PLT_CN) %>%
  mutate(number.conditions = length(COND_STATUS_CD)) %>%
  ungroup() %>%
  filter(number.conditions == 1) %>%
  filter(DSTRBCD1 < 30 | DSTRBCD1 > 32) %>%
  filter(FORTYPCD != 999)

#Creating a column FORTYPCD to join forest type data with condition data.
fia_forest_types <- fia_forest_types %>%
  mutate(FORTYPCD = VALUE)

#Joining forest type data with cond_check data.
#Start with 217 plots.
#Looked at forest types and some may not be good for comparison.
#Removed bigleaf maple (n = 1), mountain hemlock (n = 1),
#Canyon live oak (n = 2), and CA black oak (n = 5)
#End with 208 plots.
forest_types_join<- inner_join(condition_join, fia_forest_types, by = "FORTYPCD") %>%
  filter(MEANING != "Bigleaf maple") %>%
  filter(MEANING != "Mountain hemlock") %>%
  filter(MEANING != "Canyon live oak") %>%
  filter(MEANING != "California black oak") %>%
  dplyr::select(PLT_CN,
                FORTYPCD,
                TYPGRPCD,
                MEANING)

#Joining tree data with forest type data.
#Start with 208 plots.
#Subsetting relevant columns for analysis.
#Keeping only live trees with a DBH >= 12 inches (cut-off DBH for Collins Pine QQ data).
tree_join <- inner_join(forest_types_join, FIA_TREE, by = c("PLT_CN")) %>%
  dplyr::select(PLT_CN,
         STATUSCD,
         DIA,
         TPA_UNADJ,
         SPCD) %>%
  filter(STATUSCD == 1 & DIA >= 12)

#Joining species data with tree_join data.
#Start with 208 plots.
#Species include: ABCO, ABMA, ABSH (A. shastensis), ACMA, CADE,
#JUOC, PICO, PIJE, PILA, PIMO (p. monticola), PIPO, 
#POBAT (P. balsimifera spp. trichocarpa), PSME, QUCH, and QUKE.
#Removed hardwoods from dataset.
#Some plots only had hardwoods (6 plots removed, 202 plots remain).
#Calculate density of trees (>12 in DBH) for each plot.
#Calculate density of trees 12-24 DBH, 24-36 DBH, 36+ DBH.
#Calculate live BA in sq m/ha for each plot.
#Removed plots where live BA < 9 m^2/ha (43 plots removed; 159 plots remain).
#Estimating live BA by species for each plot.
#Collapsing rows to have single value for each species in each plot.
#Extracting relevant columns for analysis.
#Creating columns of live BA for each species.
#Collapsing rows to have single value for each species in each plot.
#Replacing NA with 0 for live BA by species.
#Renaming column headers to match Jens' code.
#Removing plots without Abies or Pinus spp (4 plots removed, 155 plots remain)
#End with 155 plots.
species_join <- inner_join(tree_join, fia_species_list, by = "SPCD") %>%
  filter(SPECIES_SYMBOL != "QUCH2") %>%
  filter(SPECIES_SYMBOL != "QUKE") %>%
  filter(SPECIES_SYMBOL != "ACMA3") %>%
  filter(SPECIES_SYMBOL != "POBAT") %>%
  group_by(PLT_CN) %>%
  mutate(DENS_12plus = density.FUN(TPA_UNADJ),
         DENS_12_24 = density.FUN(TPA_UNADJ[which(between(DIA, 11.99, 23.99))]),
         DENS_24_36 = density.FUN(TPA_UNADJ[which(between(DIA, 23.99, 35.99))]),
         DENS_36plus = density.FUN(TPA_UNADJ[which(DIA>35.99)]),
         BALIVE_sqmha = liveba.FUN(DIA, TPA_UNADJ)) %>%
  ungroup() %>%
  filter(BALIVE_sqmha > 8.9) %>%
  group_by(PLT_CN, SPECIES_SYMBOL) %>%
  mutate(BA_met = liveba.FUN(DIA, TPA_UNADJ)) %>%
  distinct(PLT_CN, .keep_all = TRUE) %>%
  dplyr::select(PLT_CN,
                DENS_12plus,
                DENS_12_24,
                DENS_24_36,
                DENS_36plus,
                BALIVE_sqmha,
                SPECIES_SYMBOL,
                BA_met) %>%
  ungroup() %>%
  spread(., "SPECIES_SYMBOL", "BA_met") %>%
  replace(is.na(.), 0) %>%
  rename(ABCO_met = ABCO,
         ABMA_met = ABMA,
         ABSH_met = ABSH,
         CADE_met = CADE27,
         JUNIPER_met = JUOC,
         PICO_met = PICO,
         PIJE_met = PIJE,
         PILA_met = PILA,
         PIMO_met = PIMO3,
         PIPO_met = PIPO,
         PSME_met = PSME) %>%
  group_by(PLT_CN) %>%
  mutate(AB_PI = (ABCO_met + ABMA_met + ABSH_met)/
           (ABCO_met + ABMA_met + ABSH_met + PICO_met + 
              PIJE_met + PILA_met + PIPO_met + PIMO_met)) %>%
  filter(AB_PI >= 0)
  
#Joining tables to get all information for plots.
#Final FIA dataset has 155 plots.
#Of those plots, 119 plots are under federal/state ownership,
#And 40 plots are under private ownership.
d_FIA <- inner_join(species_join, condition_join, by = "PLT_CN")
d_FIA <- inner_join(d_FIA, forest_types_join, by = c("PLT_CN", "FORTYPCD"))

owner.check <- d_FIA %>%
  group_by(OWNGRPCD) %>%
  summarise(count = length(OWNGRPCD))

#Export extracted FIA data to .csv file
write.csv(d_FIA, here("Data/Derived", "d_FIA_minus_hardwoods.csv"), row.names = FALSE)
```
